# 阅读追踪错误修复说明

## 问题描述

在阅读界面点击"结束阅读"时，无法保存阅读记录，产生错误：

```
Error: no such table: main.books
```

## 错误原因

根本原因是 `readingTrackingService.js` 在模块加载时缓存了数据库连接：
1. 模块加载时，`readingTrackingService` 构造函数被调用
2. 构造函数将 `databaseService.calibreDb` 和 `databaseService.talebookDb` 缓存到实例属性 `this.db` 和 `this.qcDb`
3. 如果之后数据库连接被更新（例如用户更改了数据库路径），缓存的连接就失效了
4. 当尝试查询 books 表时，可能连接到了错误的数据库或已失效的连接

## 解决方案

修改了 `server/services/readingTrackingService.js`：

### 1. 移除数据库连接缓存

**修改前：**
```javascript
constructor() {
  this.db = databaseService.calibreDb;
  this.qcDb = databaseService.talebookDb;
}
```

**修改后：**
```javascript
constructor() {
  // 不再缓存数据库连接
}
```

### 2. 每次方法调用时获取最新连接

**修改前：**
```javascript
async updateBookReadingStats(bookId, readerId, duration, pagesRead, readDate) {
  const calibreDb = this.db;
  const talebookDb = this.qcDb;
  // ...
}
```

**修改后：**
```javascript
async updateBookReadingStats(bookId, readerId, duration, pagesRead, readDate) {
  const calibreDb = databaseService.calibreDb;
  const talebookDb = databaseService.talebookDb;
  // ...
}
```

### 3. 增加books表存在性检查

在 `updateBookReadingStats` 方法中增加了检查：

```javascript
// 先检查 books 表是否存在
const booksTableCheck = calibreDb.prepare(
  "SELECT name FROM sqlite_master WHERE type='table' AND name='books'"
).get();
if (!booksTableCheck) {
  console.warn('⚠️  Calibre 数据库中不存在 books 表，跳过页数查询');
} else {
  const book = calibreDb.prepare('SELECT pages FROM books WHERE id = ?').get(bookId);
  totalPages = book?.pages || 0;
}
```

## 修复的方法

以下方法都已修复，不再使用缓存的数据库连接：

1. `updateBookReadingStats` - 更新书籍阅读统计
2. `getBookReadingStats` - 获取书籍阅读统计
3. `getDailyReadingDetails` - 获取每日阅读详情
4. `getHeatmapData` - 获取热力图数据
5. `getReaderSummary` - 获取读者汇总统计
6. `updateDailyReadingStats` - 更新每日阅读统计
7. `getDailyReadingStats` - 获取每日阅读统计

## 如何验证修复

1. **重启服务器**

```bash
cd server
npm run dev
```

2. **打开浏览器，进入阅读界面**
3. **点击"开始阅读"**
4. **等待一段时间后，点击"结束阅读"**
5. **检查是否成功保存阅读记录**

## 技术细节

### 为什么会缓存数据库连接？

缓存数据库连接是为了性能优化，避免每次方法调用都要访问 `databaseService` 对象。但这个假设的前提是数据库连接在服务运行期间不会改变。

### 什么时候数据库连接会改变？

1. 用户在配置界面更改了数据库路径
2. 服务器启动时数据库初始化延迟
3. 数据库文件被替换或移动

### 为什么不缓存更安全？

- **实时性**：总是使用最新的数据库连接，确保数据一致性
- **容错性**：即使数据库连接被更新，也不会出现连接失效的问题
- **可维护性**：代码更清晰，不需要管理连接状态

## 后续建议

1. **监控数据库连接状态**：可以添加定期检查数据库连接是否有效的机制
2. **添加连接池**：如果性能成为问题，可以考虑使用连接池来优化
3. **错误恢复**：如果数据库连接失败，可以尝试自动重新连接

## 相关文件

- `server/services/readingTrackingService.js` - 主要修复文件
- `server/services/databaseService.js` - 数据库服务
- `server/routes/readingTracking.js` - 阅读追踪API路由

## 测试清单

- [x] 修复代码，移除数据库连接缓存
- [x] 增加books表存在性检查
- [x] 检查lint错误（无错误）
- [ ] 重启服务器并测试阅读记录保存功能
- [ ] 验证阅读统计功能正常
- [ ] 验证热力图数据正常
