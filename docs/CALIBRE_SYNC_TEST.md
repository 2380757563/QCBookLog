# Calibre 同步功能测试指南

## 📋 功能说明

基于 Calibre-Web 的同步机制，实现了 QC-booklog 与 Calibre 的双向同步：
- 直接共享 Calibre 的 metadata.db 数据库
- 应用和 Calibre 同时读写同一个数据库文件
- 通过 WAL 检查点实现实时同步

---

## 🚀 快速开始

### 1. 启动应用

```bash
cd D:\下载\docs-xmnote-master\QC-booklog
npm run dev
```

### 2. 访问配置页面

打开浏览器访问：`http://localhost:7402/config`

或者：
1. 打开应用主页
2. 点击底部导航的"功能中心"
3. 找到"配置 Calibre"卡片并点击

### 3. 配置 Calibre 书库路径

1. 输入您的 Calibre 书库目录路径，例如：
   - Windows: `D:\MyBooks\Calibre Library`
   - macOS: `/Users/yourname/Documents/Calibre Library`
   - Linux: `/home/yourname/Calibre Library`

2. 点击"验证书库"按钮

3. 验证通过后，会显示：
   - 书籍数量
   - 书库 UUID
   - 数据库路径

4. 点击"保存配置"完成设置

---

## 🧪 测试步骤

### 测试 1：应用添加书籍 → Calibre 查看同步

**目标**：验证应用添加的书籍能立即出现在 Calibre 中

**步骤**：

1. **在应用中添加书籍**
   - 打开应用主页
   - 点击底部导航的"书库"
   - 点击右上角的"+"按钮或"添加书籍"
   - 填写书籍信息：
     - 书名：同步测试书籍 1
     - 作者：测试作者
     - ISBN：1234567890（可选）
     - 描述：这是测试同步功能的书籍
   - 点击"保存"

2. **在 Calibre 中验证**
   - 打开 Calibre 桌面应用
   - **无需刷新**，书籍应该自动出现
   - 应该能看到"同步测试书籍 1"

**预期结果**：✅ 书籍立即出现在 Calibre 中

**如果失败**：
- 检查应用是否正确配置了 Calibre 书库路径
- 查看 Calibre 控制台是否有错误信息
- 尝试在 Calibre 中点击"刷新"按钮

---

### 测试 2：Calibre 修改书籍 → 应用查看同步

**目标**：验证 Calibre 的修改能同步到应用中

**步骤**：

1. **在 Calibre 中修改书籍**
   - 在 Calibre 中找到"同步测试书籍 1"
   - 右键点击书籍 → 编辑元数据
   - 修改书名：同步测试书籍 1（已修改）
   - 点击"确定"保存

2. **在应用中验证**
   - 打开应用
   - 刷新页面（F5 或 Cmd+R）
   - 找到该书，应该看到书名已更新

**预期结果**：✅ 书籍信息已同步

**注意**：从 Calibre 到应用的同步需要刷新应用页面，因为应用有前端缓存。

---

### 测试 3：应用删除书籍 → Calibre 查看同步

**目标**：验证应用删除的书籍能立即从 Calibre 中消失

**步骤**：

1. **在应用中删除书籍**
   - 在应用中找到"同步测试书籍 1"
   - 点击书籍进入详情页
   - 点击"删除"按钮
   - 确认删除

2. **在 Calibre 中验证**
   - 打开 Calibre
   - **无需刷新**，书籍应该自动消失

**预期结果**：✅ 书籍已从 Calibre 中删除

---

### 测试 4：Calibre 添加书籍 → 应用查看同步

**目标**：验证 Calibre 添加的书籍能同步到应用中

**步骤**：

1. **在 Calibre 中添加书籍**
   - 在 Calibre 中导入一本新书
   - 添加作者、标签等信息
   - 保存

2. **在应用中验证**
   - 刷新应用页面（F5 或 Cmd+R）
   - 应该能看到 Calibre 中刚添加的书籍

**预期结果**：✅ 书籍已同步到应用

---

### 测试 5：批量操作测试

**目标**：验证批量操作的同步

**步骤**：

1. **在应用中批量添加书籍**
   - 使用应用的批量扫描功能
   - 添加 3-5 本书
   - 保存

2. **在 Calibre 中验证**
   - 所有书籍应该立即出现

3. **在 Calibre 中批量修改**
   - 选择 2-3 本书
   - 批量修改标签
   - 保存

4. **在应用中验证**
   - 刷新页面
   - 所有书籍的标签应该已更新

**预期结果**：✅ 批量操作同步成功

---

## ⚠️ 注意事项

### 1. 权限问题

确保应用有足够的权限读写 `metadata.db` 文件：

- **Windows**：以管理员身份运行应用
- **macOS/Linux**：确保数据库文件有正确的读写权限

```bash
# Linux/macOS 设置权限
chmod 644 metadata.db
```

### 2. 并发访问

虽然 SQLite 支持并发访问，但建议：

- ✅ 允许：一个应用添加书籍，另一个应用查看
- ✅ 允许：一个应用修改书籍，另一个应用查看
- ⚠️ 避免：同时在两个应用中对同一本书进行复杂的编辑操作
- ❌ 避免：同时在两个应用中删除同一本书

### 3. 数据库损坏

极端情况下，并发写入可能导致数据库损坏：

- **定期备份**：建议每天备份 `metadata.db`
- **重要操作前备份**：进行批量操作前，先备份数据库
- **使用 WAL 模式**：系统已启用 WAL 模式，大大降低了损坏风险

```bash
# 备份数据库（Windows）
copy metadata.db metadata.db.backup

# 备份数据库（macOS/Linux）
cp metadata.db metadata.db.backup
```

### 4. 缓存机制

应用可能有临时缓存：

- 重要操作后刷新页面确认结果
- 使用"无痕模式"测试，避免缓存影响
- 清除浏览器缓存后测试

---

## 🐛 常见问题

### 问题 1：配置验证失败

**错误信息**：`不是有效的 Calibre 数据库`

**解决方案**：
- 确保选择的是包含 `metadata.db` 的书库目录
- 不要直接选择 `metadata.db` 文件
- 确保目录结构如下：
  ```
  Calibre Library/
  ├── metadata.db
  ├── authors.db
  ├── *.epub
  ├── *.mobi
  └── ...
  ```

### 问题 2：同步延迟

**现象**：应用操作后，Calibre 需要几秒钟才能看到变化

**解决方案**：
- 这是正常现象，Calibre 需要检测数据库变化
- 可以在 Calibre 中点击"刷新"按钮加速
- 确保 WAL 检查点已执行（系统已自动配置）

### 问题 3：数据不一致

**现象**：应用和 Calibre 显示的数据不一致

**解决方案**：
1. 刷新应用页面
2. 在 Calibre 中点击"刷新"按钮
3. 检查是否有多个 Calibre 实例在运行
4. 检查是否有其他应用在访问数据库

### 问题 4：配置后仍然使用旧数据库

**现象**：配置了新的 Calibre 书库路径，但应用仍在使用旧数据库

**解决方案**：
1. 重启应用服务器：
   ```bash
   # 停止服务
   npm run stop

   # 启动服务
   npm run dev
   ```
2. 检查环境变量是否正确设置
3. 清除浏览器缓存

---

## 📊 性能优化

### WAL 模式

系统已启用 WAL（Write-Ahead Logging）模式，优点：

- ✅ 允许并发读写
- ✅ 提高写入性能
- ✅ 降低数据库损坏风险
- ✅ 通过检查点实现实时同步

### 同步机制

每次数据库操作后，系统会自动执行：

```sql
PRAGMA wal_checkpoint(PASSIVE);
PRAGMA synchronous = FULL;
```

确保数据立即从 WAL 文件同步到主数据库文件，Calibre 可以立即看到变更。

---

## 🔧 高级配置

### 环境变量配置

可以在启动时直接指定 Calibre 书库路径：

**Windows**:
```cmd
set CALIBRE_DB_PATH=D:\MyBooks\Calibre Library\metadata.db
npm run dev
```

**macOS/Linux**:
```bash
export CALIBRE_DB_PATH=/Users/yourname/Calibre Library/metadata.db
npm run dev
```

### 配置文件持久化

当前配置保存在环境变量中，重启后需要重新配置。

如需持久化配置，可以：

1. 创建 `.env` 文件：
   ```
   CALIBRE_DB_PATH=D:\MyBooks\Calibre Library\metadata.db
   ```

2. 修改 `databaseService.js`，从 `.env` 文件读取配置（需安装 `dotenv`）

---

## ✅ 验收标准

同步功能验收标准：

- [x] 应用可以成功配置 Calibre 书库路径
- [ ] 应用添加的书籍能立即出现在 Calibre 中
- [ ] Calibre 修改的书籍能同步到应用中
- [ ] 应用删除的书籍能立即从 Calibre 中消失
- [ ] Calibre 添加的书籍能同步到应用中
- [ ] 批量操作能正常同步
- [ ] 并发访问不会导致数据库损坏
- [ ] 配置页面用户友好，验证功能正常

---

## 📝 总结

本功能实现了 QC-booklog 与 Calibre 的双向实时同步：

**优点**：
- ✅ 简单直接，只有一个数据库文件
- ✅ 真正的实时同步
- ✅ 和 Calibre-Web 完全一致的同步机制
- ✅ 无需额外配置，一次配置永久使用

**注意事项**：
- ⚠️ 避免同时在两个应用中对同一本书进行复杂编辑
- ⚠️ 定期备份 metadata.db
- ⚠️ 重要操作后刷新页面确认结果

**测试建议**：
1. 先完成单个书籍的增删改查同步测试
2. 再进行批量操作测试
3. 最后进行并发访问压力测试

---

## 🆘 获取帮助

如遇到问题：

1. 查看应用日志：`server/logs/app.log`
2. 查看 Calibre 控制台输出
3. 检查数据库文件权限
4. 参考本文档的常见问题部分
