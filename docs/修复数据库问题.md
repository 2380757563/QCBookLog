# 修复阅读记录数据库错误

## 已修复的错误

### 错误 1：no such table: main.users
**原因**：阅读追踪功能需要 `users` 表，但数据库中还没有创建这个表。

**解决方案**：已在 `databaseService.js` 的 `initQcTables` 方法中添加自动创建 `users` 表的代码。

### 错误 2：no such table: main.books
**原因**：`books` 表在 Calibre 数据库（calibreDb），而 `qc_reading_records` 表在 Talebook 数据库（talebookDb），但阅读追踪服务只连接了 Talebook 数据库。

**解决方案**：已修改 `readingTrackingService.js`：
1. 同时连接两个数据库（calibreDb 和 talebookDb）
2. 使用 calibreDb 查询书籍信息
3. 使用 talebookDb 操作阅读记录和统计数据

## 解决方案（三选一）

### 方案 1：重启服务器（推荐）

我已经修改了数据库初始化代码，现在会自动创建必要的表。

1. 停止当前运行的服务器（按 Ctrl+C）
2. 重新启动服务器：
   ```bash
   npm run dev
   ```
3. 打开浏览器，再次尝试开始阅读

### 方案 2：手动运行修复脚本

如果重启服务器后仍然报错，运行以下命令：

从项目根目录运行：
```bash
node fix-reading-tables.js
```

然后重启服务器。

### 方案 3：使用 SQLite 工具手动创建表

如果上述方法都不行，使用 SQLite 工具打开数据库：

1. 下载并安装 [DB Browser for SQLite](https://sqlitebrowser.org/)
2. 打开文件：`data/calibre-webserver.db`
3. 执行以下 SQL：

```sql
-- 创建 users 表
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL UNIQUE,
  name TEXT,
  email TEXT UNIQUE,
  avatar TEXT,
  admin INTEGER DEFAULT 0,
  active INTEGER DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 插入默认用户
INSERT OR IGNORE INTO users (id, username, name, admin, active)
VALUES (1, 'default', '默认用户', 1, 1);

-- 创建阅读记录表
CREATE TABLE IF NOT EXISTS qc_reading_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  book_id INTEGER NOT NULL,
  reader_id INTEGER NOT NULL,
  start_time DATETIME NOT NULL,
  end_time DATETIME NOT NULL,
  duration INTEGER NOT NULL,
  start_page INTEGER NOT NULL DEFAULT 0,
  end_page INTEGER NOT NULL DEFAULT 0,
  pages_read INTEGER NOT NULL DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建每日阅读统计表
CREATE TABLE IF NOT EXISTS qc_daily_reading_stats (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  reader_id INTEGER NOT NULL,
  date DATE NOT NULL,
  total_books INTEGER DEFAULT 0,
  total_pages INTEGER DEFAULT 0,
  total_time INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(reader_id, date)
);
```

4. 保存更改
5. 关闭数据库工具
6. 重启服务器

## 修复后功能

修复完成后，以下功能将正常工作：

✅ 开始阅读按钮
✅ 阅读计时器
✅ 快速书摘功能
✅ 阅读记录保存
✅ 每日阅读统计

## 验证修复

启动服务器后，查看控制台输出，应该看到类似信息：

```
✅ users 表创建成功
✅ 默认用户已创建
✅ qc_reading_records 表创建完成
✅ qc_daily_reading_stats 表创建完成
✅ qc_bookdata 表已包含所有必要字段
```

如果看到这些信息，说明数据库修复成功！

## 技术细节

### 双数据库连接策略

阅读追踪服务现在使用两个数据库连接：
- **calibreDb**: 用于查询 `books` 表（书籍信息）
- **qcDb**: 用于操作阅读记录相关的表（qc_reading_records, qc_daily_reading_stats, qc_bookdata）

### 数据流向

1. **创建阅读记录**：
   - 插入 qc_reading_records（talebookDb）
   - 更新 qc_bookdata（talebookDb）
   - 更新 qc_daily_reading_stats（talebookDb）

2. **查询阅读记录**：
   - 从 qc_reading_records 获取记录（talebookDb）
   - 从 books 获取书籍信息（calibreDb）
   - 合并结果返回

3. **查询阅读统计**：
   - 从 qc_bookdata 获取阅读统计（talebookDb）
   - 从 books 获取书籍页数（calibreDb）
   - 计算进度百分比

